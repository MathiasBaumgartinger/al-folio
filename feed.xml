<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="MathiasBaumgartinger.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="MathiasBaumgartinger.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2025-11-07T12:12:22+00:00</updated><id>MathiasBaumgartinger.github.io/feed.xml</id><title type="html">blank</title><subtitle>My personalized academic website built with Jekyll and the al-folio theme. </subtitle><entry><title type="html">Extending Django Knox by secure refresh-tokens</title><link href="MathiasBaumgartinger.github.io/blog/2025/knox+refresh/" rel="alternate" type="text/html" title="Extending Django Knox by secure refresh-tokens"/><published>2025-08-15T00:00:00+00:00</published><updated>2025-08-15T00:00:00+00:00</updated><id>MathiasBaumgartinger.github.io/blog/2025/knox+refresh</id><content type="html" xml:base="MathiasBaumgartinger.github.io/blog/2025/knox+refresh/"><![CDATA[<h2 id="tldr">TL;DR</h2> <p>As a small exercise, I moved Django-Rest-Knox to a <strong>token-based auth</strong> with <strong>short-lived access tokens</strong> and <strong>rotate-on-use refresh tokens</strong> stored in <strong>HTTP-only, <code class="language-plaintext highlighter-rouge">Secure</code>, <code class="language-plaintext highlighter-rouge">SameSite</code> cookies</strong>. Key changes:</p> <ul> <li><strong>Knox</strong> still issues/access-validates tokens, but <strong>refresh is handled via dedicated endpoints</strong> with rotation (old refresh invalidated, new refresh set).</li> <li><strong>CSRF</strong> enforced on state-changing routes; <strong>CORS</strong> reduced to explicit origins; cookies are <code class="language-plaintext highlighter-rouge">HttpOnly+Secure</code> and scoped.</li> <li><strong>Logout</strong> clears refresh cookie <strong>and</strong> invalidates access/refresh server-side; no dangling session cookies.</li> </ul> <p>Result: less sticky auth state, clearer client flow, and fewer foot-guns when users jump across multiple SPAs.</p> <hr/> <h2 id="from-sessions-to-tokens-in-django">From Sessions to Tokens in Django</h2> <p>Django’s default authentication mechanism is a server-side, session-based system provided by its built-in auth framework. While this works perfectly for traditional, browser-rendered applications, modern platforms often expose APIs that are consumed by multiple clients: SPAs, mobile apps, or third-party integrations. In such cases, authentication requires a more flexible approach.</p> <p>Django REST Knox extends Django REST Framework’s default TokenAuthentication with a more secure and scalable implementation: it supports multiple tokens per user (for different devices), stores token hashes instead of raw tokens in the database, and adds built-in token expiry handling.</p> <p>Although no system can be entirely immune to compromise, single-token setups share a major weakness: once an attacker gains access to a valid token, they can impersonate the user until it expires. A more modern and secure alternative is the short-lived access token with a long-lived refresh token paradigm (s-a/l-r). Depending on the vulnerability, short usually refers to a time window of a few minutes to a few hours. In some ‘strict’ implementations the short-access is stored only in-memory and never saved into a local or session storage. Long refresh on the other hand usually means multiple hours to days.</p> <aside> It is important to note, that the major reason for using JWT usually is its statelessness and thus its portability and SSO-compatibility. So Knox authentication - even with the extension of a refresh-token - is still stateful: validation depends on a database lookup (the token table). That’s fundamentally different from a JWT, which is self-verifying (no lookup required). </aside> <p>While frameworks such as JSON Web Token (JWT) - when configured accordingly - provide this pattern out-of-the-box, I decided to implement a refresh-token mechanism on top of Django REST Knox. While it serves as a security enhancement for a platform I developed, my key goal was a deeper understanding of modern authentication approaches; an advanced exercise in understanding (Django’s) authentication internals.</p> <aside> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/knox+refresh/jwt-480.webp 480w,/assets/img/blog/knox+refresh/jwt-800.webp 800w,/assets/img/blog/knox+refresh/jwt-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/knox+refresh/jwt.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> Above is an exemplary flow of a JWT setup where - after the authentication server served the token - validation no longer depends on this server. </aside> <hr/> <h2 id="what-why-and-how">What, Why and How?</h2> <p>In an s-a/l-r architecture, on login the user is granted a refresh token. Usually, this refresh token has an expiry of a longer period, say multiple days. Using this refresh token, they generate a short lived access token. This token alone provides is what</p> <p>Why do we take this extra step? There is more than just one simple answer to this question; it is highly debated in the community and ultimately always a trade-off.</p> <p>As mentioned above, one major threat of single-token setups is security. No system is entirely save and the possibility of a token being stolen cannot be fully eradicated. A short-lived access token does not mitigate the risk of tokens being stolen, they do however mitigate the attack surface in a time-dimension.</p> <p>To actually obtain this security benefits, we have to ensure following implementation details:</p> <ul> <li><strong>Short-livedness of access tokens</strong>: keep the access token as short-lived as arguable. Even if they are somehow hijacked, the risk potential is reduced severely.</li> <li><strong>HTTP-only refresh</strong>: protect the long-lived aspect of the setup from being hijacked via XSS attacks by making it inaccessible for javascript</li> <li><strong>CSRF validation</strong>: HTTP-only cookies are automatically included in every request to the backend. A malicious cross-site-request-forgery (CSRF) attack from another site to a state-changing endpoint may result in unwanted actions. We need to ensure we validate no such attack is happening from another site.</li> </ul> <hr/> <h2 id="implementation-details-backend">Implementation Details: Backend</h2> <p>The goal of this exercise is to described by the flowchart below; it demonstrates the intended flow of logging in and out:</p> <pre><code class="language-mermaid">flowchart LR
  A["Credentials: username/password&lt;br/&gt;or social callback"] --&gt;|/api/login| B["Issue Access + Refresh"]
  B --&gt;|"Access (Authorization: Token …)"| C["API endpoints"]
  C --&gt;|401 / expired| D["/api/token/refresh"]
  D --&gt;|Rotate refresh; set new cookie| B
  E["/api/logout"] --&gt;|Invalidate / clear cookie| F["Logged out everywhere"]
</code></pre> <p>Instead of the plain (or maybe extended) <code class="language-plaintext highlighter-rouge">KnoxLoginView</code>, a custom <code class="language-plaintext highlighter-rouge">APIView</code> will be extended as <code class="language-plaintext highlighter-rouge">LoginView</code>. On valid login, a custom ORM-class <code class="language-plaintext highlighter-rouge">RefreshToken</code> will be created and a <code class="language-plaintext highlighter-rouge">HTTPOnly</code> cookie is set for the user using the <code class="language-plaintext highlighter-rouge">RefreshToken</code>s key. Simultaneously, an access-token - Knox’s <code class="language-plaintext highlighter-rouge">AuthToken</code> - is created. In our vue SPA, we use a store for managing our authentication: each request to our server is proxied by the store - we check whether the access token is still valid, otherwise we try to refresh it using the <code class="language-plaintext highlighter-rouge">RefreshToken</code> which then is rotated. Any other case requires a new login attempt.</p> <hr/> <h3 id="settings">Settings</h3> <p>First of all, in Django’s <code class="language-plaintext highlighter-rouge">settings.py</code> we add two new variables to control the lifetimes of our tokens:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">REST_KNOX</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">TOKEN_TTL</span><span class="sh">'</span><span class="p">:</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">REFRESH_TOKEN_TTL</span> <span class="o">=</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></div> <h3 id="refresh-token-model">Refresh Token Model</h3> <p>As a second step, we implement our refresh-token. Multiple refresh-tokens per user should be possible to keep Knox’s multi-device capabilities. Each refresh-token has a key, which is used to verify against the <code class="language-plaintext highlighter-rouge">HTTPOnly</code>cookie which is being set when logging in. The expiration-date of the refresh token is derived from <code class="language-plaintext highlighter-rouge">REFRESH_TOKEN_TTL</code>. Additionally, this model adds rotation and revocation logic, providing a mechanism similar to JWT refresh behavior but still database-controlled (stateful). With <code class="language-plaintext highlighter-rouge">RefreshToken.rotate</code> the current token is rendered invalid, while returning a newly created <code class="language-plaintext highlighter-rouge">RefreshToken</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="n">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="n">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="n">secrets</span>

<span class="k">class</span> <span class="nc">RefreshToken</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">expires_at</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">DateTimeField</span><span class="p">()</span>
    <span class="n">rotated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">revoked</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="nc">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">expiration_time</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">REFRESH_TOKEN_TTL</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">token_urlsafe</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">expiration_time</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">expiration_time</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">REFRESH_TOKEN_TTL</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rotated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">rotated</span><span class="sh">"</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revoke</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
      <span class="n">self</span><span class="p">.</span><span class="n">revoked</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="n">self</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">update_fields</span><span class="p">[</span><span class="sh">"</span><span class="s">revoked</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div> <hr/> <h3 id="views-overview">Views Overview</h3> <p>To handle the refresh-token, we require a <code class="language-plaintext highlighter-rouge">Login</code>-, <code class="language-plaintext highlighter-rouge">Logout</code>- and most importantly <code class="language-plaintext highlighter-rouge">RefreshView</code>. To prevent csrf-theft we will decorate them with Django’s <code class="language-plaintext highlighter-rouge">csrf_protect</code> decorator.</p> <h4 id="login">Login</h4> <p>We will use <code class="language-plaintext highlighter-rouge">rest_framework.authtoken.serializers.AuthTokenSerializer</code> to validate the user login attempt. On a successful login, we further create an access token (a <code class="language-plaintext highlighter-rouge">knox.models.AuthToken</code>) and a refresh token (or custom <code class="language-plaintext highlighter-rouge">RefreshToken</code>). The <code class="language-plaintext highlighter-rouge">AuthToken</code> implicitly takes its expiration date from the <code class="language-plaintext highlighter-rouge">TOKEN_TTL</code> setting we configured earlier.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="n">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="n">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="n">knox.models</span> <span class="kn">import</span> <span class="n">AuthToken</span>
<span class="kn">from</span> <span class="n">rest_framework.authtoken.serializers</span> <span class="kn">import</span> <span class="n">AuthTokenSerializer</span>
<span class="kn">from</span> <span class="n">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_protect</span>
<span class="kn">from</span> <span class="n">.models</span> <span class="kn">import</span> <span class="n">RefreshToken</span>
<span class="kn">from</span> <span class="n">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="n">.util.cookies</span> <span class="kn">import</span> <span class="n">set_refresh_cookie</span><span class="p">,</span> <span class="n">clear_refresh_cookie</span>
<span class="kn">from</span> <span class="n">auth.knox</span> <span class="kn">import</span> <span class="n">TokenAuthentication</span>


<span class="k">class</span> <span class="nc">LoginView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">permissions</span><span class="p">.</span><span class="n">AllowAny</span><span class="p">]</span>

    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_protect</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="nc">AuthTokenSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">serializer</span><span class="p">.</span><span class="nf">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">validated_data</span><span class="p">[</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">access_token_obj</span><span class="p">,</span> <span class="n">access_token</span> <span class="o">=</span> <span class="n">AuthToken</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">RefreshToken</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nc">Response</span><span class="p">({</span><span class="sh">"</span><span class="s">token</span><span class="sh">"</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="sh">"</span><span class="s">expiry</span><span class="sh">"</span><span class="p">:</span> <span class="n">access_token_obj</span><span class="p">.</span><span class="n">expiry</span><span class="p">})</span>
        <span class="nf">set_refresh_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">rt</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div> <p>In <code class="language-plaintext highlighter-rouge">util/cookies.py</code> we create two helper functions for creating and revoking cookies for responses:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">set_refresh_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">REFRESH_TOKEN_TTL</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">set_cookie</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="sh">"</span><span class="s">Lax</span><span class="sh">"</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clear_refresh_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">delete_cookie</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh</span><span class="sh">"</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>This is also were we finally set the <code class="language-plaintext highlighter-rouge">httponly</code> to <code class="language-plaintext highlighter-rouge">True</code> to prevent any malicious attempts of reading the refresh token using XSS. Furthermore, when we use a refresh token stored in HTTP-only cookies, the users browser automatically includes that cookie with every request to the backend, which opens a <code class="language-plaintext highlighter-rouge">csrf</code> attack vector: Remember we also have to <code class="language-plaintext highlighter-rouge">csrf_protect</code> all state-changing endpoints (<code class="language-plaintext highlighter-rouge">POST/PUT/PATCH/DELETE</code>).</p> <h4 id="refresh">Refresh</h4> <p>A new <code class="language-plaintext highlighter-rouge">RefreshView</code> will allow a user to query for a new access token given they have a valid refresh token (automatically included in the request).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RefreshView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">permissions</span><span class="p">.</span><span class="n">AllowAny</span><span class="p">]</span>

    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_protect</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">COOKIES</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">Response</span><span class="p">({</span><span class="sh">"</span><span class="s">detail</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">No refresh cookie</span><span class="sh">"</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="n">RefreshToken</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">revoked</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RefreshToken</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">Response</span><span class="p">({</span><span class="sh">"</span><span class="s">detail</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Invalid refresh</span><span class="sh">"</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rt</span><span class="p">.</span><span class="n">expires_at</span> <span class="o">&lt;</span> <span class="n">timezone</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="ow">or</span> <span class="n">rt</span><span class="p">.</span><span class="n">rotated</span><span class="p">:</span>
            <span class="k">return</span> <span class="nc">Response</span><span class="p">({</span><span class="sh">"</span><span class="s">detail</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Expired/rotated</span><span class="sh">"</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
        <span class="n">new_rt</span> <span class="o">=</span> <span class="n">rt</span><span class="p">.</span><span class="nf">rotate</span><span class="p">()</span>
        <span class="n">access_token_obj</span><span class="p">,</span> <span class="n">access_token</span> <span class="o">=</span> <span class="n">AuthToken</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nc">Response</span><span class="p">({</span><span class="sh">"</span><span class="s">token</span><span class="sh">"</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="sh">"</span><span class="s">expiry</span><span class="sh">"</span><span class="p">:</span> <span class="n">access_token_obj</span><span class="p">.</span><span class="n">expiry</span><span class="p">})</span>
        <span class="nf">set_refresh_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">new_rt</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div> <h4 id="logout">Logout</h4> <p>When logging out we need to revoke both the <code class="language-plaintext highlighter-rouge">AccessToken</code> and the <code class="language-plaintext highlighter-rouge">RefreshToken</code>in the database and conveniently also clear the corresponding <code class="language-plaintext highlighter-rouge">HTTPOnly</code> refresh-cookie.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LogoutView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenAuthentication</span><span class="p">]</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">permissions</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">RefreshToken</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">revoked</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="n">revoked</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">auth</span>
        <span class="k">if</span> <span class="n">access_token</span><span class="p">:</span>
            <span class="n">access_token</span><span class="p">.</span><span class="nf">delete</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="nc">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
        <span class="nf">clear_refresh_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div> <hr/> <h2 id="implementation-details-frontend">Implementation Details: Frontend</h2> <p>For the underlying project, we chose Vue.js as our frontend. In this section we implement a convenient method for sending requests to our newly created backend using Pinia, a state management library for Vue. Pinia simplifies the process of sharing state across components, making it easier to manage application data. In practice however, the described approaches can be applied to all frameworks or even vanilla javascript. For our http-requests we will use axios.</p> <h3 id="axios-interceptor">Axios Interceptor</h3> <p>First off, we will create an axios-instance (e.g. in a <code class="language-plaintext highlighter-rouge">api.js</code>-file). This instance is what our store will handle to perform requests.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">axios</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span>
  <span class="na">baseURL</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/api/</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">withCredentials</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div> <p>It would be very inconvenient if we had to to manually check for authentication and refresh each time before we send a request. Luckily, axios implements interceptors. They will <em>intercept</em> a request before they are handled by <code class="language-plaintext highlighter-rouge">.then</code> or <code class="language-plaintext highlighter-rouge">catch</code>. Consequently, we can create an interceptor for our axios-instance that can check for <code class="language-plaintext highlighter-rouge">401: UNAUTHORIZED</code> and accordingly handle our refresh logic.</p> <p>We first define some setup:</p> <ol> <li><code class="language-plaintext highlighter-rouge">isRefreshing</code>: A boolean that handles the current state the interceptor; is it refreshing?</li> <li><code class="language-plaintext highlighter-rouge">subscribers</code>: If subsequent requests are coming in after the first one, we subscribe to the refresh using <code class="language-plaintext highlighter-rouge">subscribeTokenRefresh</code>.</li> <li><code class="language-plaintext highlighter-rouge">onRefreshed</code>: If a successful refresh did happen, we resolve all of subscribed <code class="language-plaintext highlighter-rouge">Promises</code> with this new token and empty the subscription array</li> </ol> <p>If <code class="language-plaintext highlighter-rouge">refreshAccessToken</code> does not validate, we return a rejection-Promise.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">isRefreshing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">subscribers</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nf">subscribeTokenRefresh</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">subscribers</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">onRefreshed</span><span class="p">(</span><span class="nx">newToken</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">subscribers</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">cb</span><span class="p">(</span><span class="nx">newToken</span><span class="p">));</span>
  <span class="nx">subscribers</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span>
  <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">,</span>
  <span class="k">async </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">response</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">response</span><span class="p">?.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">__isRetryRequest</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">isRefreshing</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">isRefreshing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">newToken</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">refreshAccessToken</span><span class="p">();</span>
          <span class="nx">isRefreshing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nf">onRefreshed</span><span class="p">(</span><span class="nx">newToken</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">isRefreshing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nf">useAuthStore</span><span class="p">().</span><span class="nf">logout</span><span class="p">();</span>
          <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nf">subscribeTokenRefresh</span><span class="p">((</span><span class="nx">newToken</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">__isRetryRequest</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">=</span> <span class="s2">`Token </span><span class="p">${</span><span class="nx">newToken</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
          <span class="nf">resolve</span><span class="p">(</span><span class="nf">api</span><span class="p">(</span><span class="nx">config</span><span class="p">));</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div> <p>The refresh action simply tries to access our refresh-endpoint in the backend. As stated before, the refresh-cookie is appended implicitly</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nf">refreshAccessToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/token/refresh/</span><span class="dl">"</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="na">withCredentials</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">newToken</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
  <span class="nf">useAuthStore</span><span class="p">().</span><span class="nf">setToken</span><span class="p">(</span><span class="nx">newToken</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">newToken</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="the-authentication-store">The Authentication-Store</h3> <p>For the authentication-store, we store the user, their access token and expiry. Additionally, you may store other relevant user information, e.g. their full name. The refresh token is <code class="language-plaintext highlighter-rouge">HTTPOnly</code> and thus never exposed to javascript. A simple <code class="language-plaintext highlighter-rouge">login</code> function reaches out for the login-endpoint. Note that this happens without the explicit axios-interceptor-instance, as it should not intercept for this request. If this initial login attempt was successful, we store the token immediately using <code class="language-plaintext highlighter-rouge">setToken</code>. Subsequent should happen using the <code class="language-plaintext highlighter-rouge">api</code>.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">defineStore</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">pinia</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@/api</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">useAuthStore</span> <span class="o">=</span> <span class="nf">defineStore</span><span class="p">(</span><span class="dl">"</span><span class="s2">auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">state</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
    <span class="na">token</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">expiry</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">}),</span>

  <span class="na">getters</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">isAuthenticated</span><span class="p">:</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!!</span><span class="nx">state</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span>
  <span class="p">},</span>

  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="nf">setToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">expiry</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">expiry</span> <span class="o">=</span> <span class="nx">expiry</span><span class="p">;</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">=</span> <span class="s2">`Token </span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="k">async</span> <span class="nf">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/login/</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">},</span> <span class="p">{</span> <span class="na">withCredentials</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nf">setToken</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">expiry</span><span class="p">);</span>
      <span class="c1">// THIS ENDPOINT NEEDS TO BE IMPLEMENTED</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/user-info/</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="k">async</span> <span class="nf">logout</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/logout/</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Logout error:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">expiry</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">api</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div> <h3 id="using-the-store-in-a-component">Using the Store in a Component</h3> <p>Using this authstore in a component could look like this:</p> <p>We have a login mask that on submit calls to the authstore. Once logged in, we will show the username</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;template&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"auth-demo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Demo: Login + Fetch Items<span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;form</span> <span class="err">@</span><span class="na">submit.prevent=</span><span class="s">"login"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>
        Username:
        <span class="nt">&lt;input</span> <span class="na">v-model=</span><span class="s">"username"</span> <span class="na">placeholder=</span><span class="s">"demo"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;label&gt;</span>
        Password:
        <span class="nt">&lt;input</span> <span class="na">v-model=</span><span class="s">"password"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">placeholder=</span><span class="s">"demo123"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">:disabled=</span><span class="s">"loading"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>

    <span class="nt">&lt;div</span> <span class="na">v-if=</span><span class="s">"auth.isAuthenticated"</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"status"</span><span class="nt">&gt;</span>
        Hello, you are logged in as
        <span class="nt">&lt;code&gt;&lt;/code&gt;</span>
      <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;button</span> <span class="err">@</span><span class="na">click=</span><span class="s">"getItems"</span><span class="nt">&gt;</span>Fetch Items<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="err">@</span><span class="na">click=</span><span class="s">"logout"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>

      <span class="nt">&lt;ul</span> <span class="na">v-if=</span><span class="s">"items.length"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;li</span> <span class="na">v-for=</span><span class="s">"(item, i) in items"</span> <span class="na">:key=</span><span class="s">"i"</span><span class="nt">&gt;&lt;/li&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;p</span> <span class="na">v-if=</span><span class="s">"error"</span> <span class="na">class=</span><span class="s">"error"</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;script </span><span class="na">setup</span><span class="nt">&gt;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">vue</span><span class="dl">"</span><span class="p">;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">useAuthStore</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@/stores/auth</span><span class="dl">"</span><span class="p">;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@/api</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// the configured axios instance</span>

  <span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nf">useAuthStore</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="nf">ref</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nf">ref</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">items</span> <span class="o">=</span> <span class="nf">ref</span><span class="p">([]);</span>
  <span class="kd">const</span> <span class="nx">loading</span> <span class="o">=</span> <span class="nf">ref</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="nf">ref</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nf">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">error</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="nx">loading</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">login</span><span class="p">(</span><span class="nx">username</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">password</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Login successful</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Invalid credentials</span><span class="dl">"</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">loading</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nf">getItems</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">error</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/items/</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">items</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Failed to fetch items</span><span class="dl">"</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nf">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">auth</span><span class="p">.</span><span class="nf">logout</span><span class="p">();</span>
    <span class="nx">items</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div> <hr/> <h2 id="feature-comparison">Feature-Comparison</h2> <table> <thead> <tr> <th>Feature</th> <th>Django REST Knox</th> <th>JWT</th> <th>New Knox + Refresh Extension</th> </tr> </thead> <tbody> <tr> <td>Validation</td> <td>DB lookup</td> <td>Signature verification</td> <td>DB lookup</td> </tr> <tr> <td>Revocation</td> <td>Immediate</td> <td>Hard (until expiry)</td> <td>Immediate</td> </tr> <tr> <td>Stateless</td> <td>❌</td> <td>✅</td> <td>❌</td> </tr> <tr> <td>SSO support</td> <td>❌</td> <td>✅</td> <td>❌</td> </tr> <tr> <td>Rotation</td> <td>Not required</td> <td>✅</td> <td>✅</td> </tr> <tr> <td>XSS-safe refresh</td> <td>Impl. detail</td> <td>Impl. detail</td> <td>✅</td> </tr> <tr> <td>CSRF protection</td> <td>Impl. detail</td> <td>Not required</td> <td>✅</td> </tr> </tbody> </table> <hr/> <p>This small extension closes the gap between Knox’s simplicity and JWT’s refresh-based security model.<br/> It doesn’t aim for stateless SSO portability but instead strengthens token hygiene, rotation, and logout semantics for Django-backed APIs.</p>]]></content><author><name>Mathias Baumgartinger</name></author><category term="software-engineering"/><category term="code"/><category term="python"/><category term="django"/><category term="drf"/><category term="knox"/><category term="security"/><category term="tokens"/><category term="spa"/><category term="csrf"/><category term="cors"/><summary type="html"><![CDATA[How Django-Rest-Knox auth-system can be extended: short-lived access tokens, HTTP-only refresh cookies, rotation, CSRF, and clean session semantics.]]></summary></entry><entry><title type="html">Start der BioPV-Labs: Gemeinsam die Zukunft gestalten! | BioPV</title><link href="MathiasBaumgartinger.github.io/blog/2025/start-der-biopv-labs-gemeinsam-die-zukunft-gestalten-biopv/" rel="alternate" type="text/html" title="Start der BioPV-Labs: Gemeinsam die Zukunft gestalten! | BioPV"/><published>2025-04-22T00:00:00+00:00</published><updated>2025-04-22T00:00:00+00:00</updated><id>MathiasBaumgartinger.github.io/blog/2025/start-der-biopv-labs-gemeinsam-die-zukunft-gestalten--biopv</id><content type="html" xml:base="MathiasBaumgartinger.github.io/blog/2025/start-der-biopv-labs-gemeinsam-die-zukunft-gestalten-biopv/"><![CDATA[<p>Erfahrungsaustausch und partizipatives Planen standen im Fokus der ersten BioPV-Labs, die im März und April in den Biosphärenparks Lungau und Unteres Murtal stattfanden. Stakeholder aus Regional- und Kommunalmanagement, Planung, Umsetzung und Naturschutz sowie interessierte Bürger:innen kamen zusammen, um Ideen zu entwickeln, auszutauschen und gemeinsam zu planen.Ein interaktives Planspiel mit 3D-Visualisierungen und Virtual Reality machte die Potenziale und Auswirkungen von Freiflächen-Photovoltaik erlebbar – und lieferte wertvolle Impulse für die Diskussionen über eine nachhaltige Energiezukunft. Das Projekt wird aus Mitteln des Earth System Sciences Förderprogramms der Österreichischen Akademie der Wissenschaften finanziert.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>© document.write(new Date().getFullYear()) CC BY NC ND 4.0. Theme: Research Group von Wowchemy.
</code></pre></div></div>]]></content><author><name></name></author><summary type="html"><![CDATA[Erfahrungsaustausch und partizipatives Planen standen im Fokus der ersten BioPV-Labs, die im März und April in den Biosphärenparks Lungau und Unteres Murtal stattfanden. Stakeholder aus Regional- und Kommunalmanagement, Planung, Umsetzung und Naturschutz sowie interessierte Bürger:innen kamen zusammen, um Ideen zu entwickeln, auszutauschen und gemeinsam zu planen.]]></summary></entry><entry><title type="html">Engaging the local community: WIMBY workshops in Styria</title><link href="MathiasBaumgartinger.github.io/blog/2024/engaging-the-local-community-wimby-workshops-in-styria/" rel="alternate" type="text/html" title="Engaging the local community: WIMBY workshops in Styria"/><published>2024-11-25T00:00:00+00:00</published><updated>2024-11-25T00:00:00+00:00</updated><id>MathiasBaumgartinger.github.io/blog/2024/engaging-the-local-community-wimby-workshops-in-styria</id><content type="html" xml:base="MathiasBaumgartinger.github.io/blog/2024/engaging-the-local-community-wimby-workshops-in-styria/"><![CDATA[<p>In the picturesque region of Styria, Austria, WIMBY recently hosted a set of workshops aimed at fostering local engagement and understanding around wind energy projects. This initiative was part of WIMBY’s broader efforts to explore the social acceptance of wind turbines, while addressing the concerns and perspectives of residents and stakeholders.Styria, known for its unique landscapes, is also one of the three pilot cases at the heart of the project. The workshops were held in the towns of Thannegg and Irdning, where residents and stakeholders were invited to participate in interactive sessions designed to capture a wide range of opinions about wind energy installations.These workshops were strategically designed not only to educate but also to participate. WIMBY’s goal was to create a series of tools for open discussions about the benefits and challenges of wind turbines, while encouraging local input into the decision-making process.The workshops featured a variety of engaging activities to encourage both learning and dialogue. Researchers and facilitators from the WIMBY team led different interactive exercises. One of the highlights was the 3D mapping session hosted by the University of Natural Resources and Life Sciences, Vienna (BOKU), where participants worked together to envision wind energy installations in their region. Additionally, The Kelso Institute Europe facilitated a stakeholder mapping session, helping attendees identify key groups and individuals whose perspectives would be crucial for the success of any wind energy project in the region. And Utrecht University conducted a mental modeling session where participants could visualise and express their thoughts about the potential impact of wind turbines on their community.The workshops were designed to foster trust and ensure that community members felt their voices were heard. By involving local residents and stakeholders in hands-on activities, WIMBY was able to better understand their concerns and ideas, while also providing valuable insights into how the wind energy project could be tailored to locals’ specific needs.As the local community is integral to the success of sustainable energy projects, WIMBY focused on addressing concerns such as the visual impact of wind turbines, their potential effect on wildlife, and how the development of such projects could benefit the region economically and socially.The feedback collected from these sessions will be analysed and integrated into future project planning, ensuring that wind energy development remains transparent, inclusive, and aligned with local needs. By engaging with the community in such an open and interactive manner, WIMBY hopes to pave the way for more successful and accepted wind energy projects not just in Styria, but across Europe.Stay tuned for more updates on our future workshops: next ones will be held in Portugal at the beginning of 2025! Follow WIMBY on Twitter and LinkedInDon’t forget to subscribe to our newsletter 👇SubscribeDid you follow the webinar on Holistic Impact Assessment in Wind Energy, co-organised by WIMBY, JUSTWIND4ALL and WENDY? This…Missed our webinar with the sister projects? Watch the full recording!A collection of shared thoughts from three Horizon Europe projects – WENDY, JustWind4All and WIMBY…Supporting and hindering factors that influence social acceptance and commitment to wind energy projectToday WIMBY starts with an exciting and interactive week on the island of Pantelleria (Italy),…Pantelleria workshops week begins!PRESS RELEASE WIMBY: Engaging communities for the acceptance and adoption of wind energy in the…WIMBY’s first press releaseI’ve read and I accept privacy terms and conditions.You have successfully joined our subscriber list.Wind in My Backyard: Using holistic modelling tools to advance social awareness and engagement on large wind power installations in the EU Privacy Policy</p>]]></content><author><name></name></author><summary type="html"><![CDATA[Discover how WIMBY’s workshops and activities in Styria, Austria, fostered local engagement around wind energy projects.]]></summary></entry><entry><title type="html">Istanbul – the bridge between Europe and Asia</title><link href="MathiasBaumgartinger.github.io/blog/2024/istanbul/" rel="alternate" type="text/html" title="Istanbul – the bridge between Europe and Asia"/><published>2024-06-13T00:00:00+00:00</published><updated>2024-06-13T00:00:00+00:00</updated><id>MathiasBaumgartinger.github.io/blog/2024/istanbul</id><content type="html" xml:base="MathiasBaumgartinger.github.io/blog/2024/istanbul/"><![CDATA[<p>Off we went to Istanbul. Even though we hadn’t thought about it when booking, it was strangely fitting. Located on the Bosporus, a city on two continents—Europe and Asia. I had high expectations of Istanbul, and it did not disappoint. “If the world were a nation, Istanbul would be its capital,” Napoleon once said. For historians, it’s the crème de la crème. A city of Eastern Romans with the idea of becoming the new Rome, aqueducts, cisterns, churches, and the historic Hagia Sophia. At least it used to be a church. Until the Ottomans took the city and turned it into a mosque and built Ottoman palaces and so on and so forth. Under Kemal Mustafa Atatürk, Hagia Sophia became a museum. And then later a mosque again, then a museum again, and in 2020 a mosque again. Living history, in other words. And now we’re finally heading home, so we can report back in person. See you soon, my dears.</p> <h2 id="istanbul-gallery">Istanbul Gallery</h2> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/sundown.png"> <img src="/assets/img/blog/travelling/istanbul/sundown.png" class="img-fluid rounded" alt="Sundown"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/blue_mosque.png"> <img src="/assets/img/blog/travelling/istanbul/blue_mosque.png" class="img-fluid rounded" alt="Blue mosque"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/aqueduct.png"> <img src="/assets/img/blog/travelling/istanbul/aqueduct.png" class="img-fluid rounded" alt="Aqueduct"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/medusa.png"> <img src="/assets/img/blog/travelling/istanbul/medusa.png" class="img-fluid rounded" alt="Medusa"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/basilica_cistern.png"> <img src="/assets/img/blog/travelling/istanbul/basilica_cistern.png" class="img-fluid rounded" alt="Basilica cistern"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/besiktas.png"> <img src="/assets/img/blog/travelling/istanbul/besiktas.png" class="img-fluid rounded" alt="Besiktas"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/blue_mosque_water.png"> <img src="/assets/img/blog/travelling/istanbul/blue_mosque_water.png" class="img-fluid rounded" alt="Blue mosque water"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/cats.png"> <img src="/assets/img/blog/travelling/istanbul/cats.png" class="img-fluid rounded" alt="Cats"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/flowers.png"> <img src="/assets/img/blog/travelling/istanbul/flowers.png" class="img-fluid rounded" alt="Flowers"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/food.png"> <img src="/assets/img/blog/travelling/istanbul/food.png" class="img-fluid rounded" alt="Food"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/hagia.png"> <img src="/assets/img/blog/travelling/istanbul/hagia.png" class="img-fluid rounded" alt="Hagia"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/hagia_inside.png"> <img src="/assets/img/blog/travelling/istanbul/hagia_inside.png" class="img-fluid rounded" alt="Hagia inside"/> </a></p> <p><a class="venobox" data-gall="istanbulGallery" href="/assets/img/blog/travelling/istanbul/more_cats.png"> <img src="/assets/img/blog/travelling/istanbul/more_cats.png" class="img-fluid rounded" alt="More cats"/> </a></p>]]></content><author><name></name></author><category term="travelling"/><category term="travelling"/><category term="photography"/><category term="images"/><category term="istanbul"/><summary type="html"><![CDATA[Last stop of 5 months of travel in the "center of the world": a week in Istanbul.]]></summary></entry><entry><title type="html">Pretend a Mouse: VR-GUI in Godot</title><link href="MathiasBaumgartinger.github.io/blog/2022/godot-vr-ui/" rel="alternate" type="text/html" title="Pretend a Mouse: VR-GUI in Godot"/><published>2022-02-05T00:00:00+00:00</published><updated>2022-02-05T00:00:00+00:00</updated><id>MathiasBaumgartinger.github.io/blog/2022/godot-vr-ui</id><content type="html" xml:base="MathiasBaumgartinger.github.io/blog/2022/godot-vr-ui/"><![CDATA[<h2 id="tldr">TL;DR</h2> <p>For the Godot VR Toolkit I wanted <strong>proper GUI interaction in VR</strong> without rewriting or reinventing the wheel. So, I kept using <strong>normal Godot <code class="language-plaintext highlighter-rouge">Control</code> nodes</strong> and made them think they were being used with a mouse:</p> <ul> <li>A <code class="language-plaintext highlighter-rouge">Viewport</code> hosts a regular 2D UI.</li> <li><code class="language-plaintext highlighter-rouge">ViewportToMesh.gd</code> renders that viewport onto a 3D mesh in the world.</li> <li><code class="language-plaintext highlighter-rouge">GuiInteraction.gd</code> casts rays from VR controllers into that mesh.</li> <li><code class="language-plaintext highlighter-rouge">GuiFinger.gd</code> tracks a finger tip collider for “poking” the UI.</li> <li>Both systems compute 2D coordinates inside the viewport and then <strong>synthesize <code class="language-plaintext highlighter-rouge">InputEventMouseMotion</code> / <code class="language-plaintext highlighter-rouge">InputEventMouseButton</code></strong> so the UI believes a mouse is moving and clicking.</li> </ul> <p>Result: 3D VR hands, laser pointer, hovering, clicking, dragging – but under the hood it’s still just <strong>mouse events and a viewport</strong>.</p> <p>The implementation can be found on <a href="https://github.com/boku-ilen/godot-vr-toolkit/blob/master/addons/vr-toolkit/Gui/">Github</a>.</p> <hr/> <h2 id="the-2d-vs-3d-ui-problem">The 2D vs. 3D UI Problem</h2> <p>Godot is fundamentally stable and user-friendly at 2D GUIs: <code class="language-plaintext highlighter-rouge">Control</code> hierarchies, themes, focus handling, signals – all the usual desktop UI goodies.</p> <p>VR, on the other hand, lives entirely in 3D: controllers/hand meshes, raycasts, spatial interactions and depth perception. What you <em>don’t</em> have is a mouse pointer.</p> <p>Traditionally, user interface interactions in VR are handled by casting a ray from the controller (like a “laser pointer”) or by directly pinching, hence touching objects with a virtual hand/finger. Naively, you could:</p> <ol> <li>Implement a new VR-specific widget set (buttons, sliders, etc.),</li> <li>Or try to hack <code class="language-plaintext highlighter-rouge">Control</code>s to understand “rays” and “fingers”.</li> </ol> <p>Both approaches quickly turn into a rabbit hole of <strong>“oh right, I also need hover, drag, scroll, focus, keyboard…“</strong>.</p> <p>So instead I went for a “cheaper” trick that reuses Godot’s existing 2D GUI system as much as possible;:</p> <blockquote> <p>What if we keep the entire 2D GUI stack as-is and just pretend we’re a mouse?</p> </blockquote> <p>That leads to a very simple mental model:</p> <ul> <li>From VR’s perspective: <em>“I cast a ray / move a finger to a panel.”</em></li> <li>From the UI’s perspective: <em>“The mouse moved to <code class="language-plaintext highlighter-rouge">(x, y)</code> and clicked.”</em></li> </ul> <p>Everything in between is just coordinate transformations and synthetic input events.</p> <hr/> <h2 id="overview-of-the-setup">Overview of the Setup</h2> <p>The three main scripts in play are:</p> <ul> <li> <p><a href="https://github.com/boku-ilen/godot-vr-toolkit/blob/master/addons/vr-toolkit/Gui/ViewportToMesh.gd"><code class="language-plaintext highlighter-rouge">ViewportToMesh.gd</code></a><br/> Renders a 2D <code class="language-plaintext highlighter-rouge">Viewport</code> (with <code class="language-plaintext highlighter-rouge">Control</code>s) onto a 3D mesh, including UV coordinate handling.</p> </li> <li> <p><a href="https://github.com/boku-ilen/godot-vr-toolkit/blob/master/addons/vr-toolkit/Gui/GuiInteraction.gd"><code class="language-plaintext highlighter-rouge">GuiInteraction.gd</code></a><br/> Handles ray-based interaction: a “laser pointer” from the controller that hits the GUI mesh.</p> </li> <li> <p><a href="https://github.com/boku-ilen/godot-vr-toolkit/blob/master/addons/vr-toolkit/Gui/GuiFinger.gd"><code class="language-plaintext highlighter-rouge">GuiFinger.gd</code></a><br/> Handles fingertip interaction: a collider on the tip of a VR hand that can “press” UI buttons directly.</p> </li> </ul> <p>In a slightly simplified picture:</p> <pre><code class="language-mermaid">flowchart LR
  H[VR Hand / Controller]
  H --&gt; R[Raycast]
  H --&gt; G[Finger Collider]
  R --&gt;|collide| M[GUI Mesh]
  G --&gt;|collide| M[GUI Mesh]
  M --&gt;|interpret collision point| M
  M --&gt;|pass faked mousevent| C[Viewport]
  C --&gt; E[Godot GUI system]
</code></pre> <p>The resulting faked mouse events are then processed by Godot’s normal GUI system, triggering hover states, button presses, etc..</p> <h2 id="viewporttomesh---putting-ui-into-the-world">ViewportToMesh - putting UI into the world</h2> <p>The starting point is trivial – rendering a UI to a texture and show it on a mesh:</p> <ul> <li>Inside that viewport lives a normal 2D UI: <ul> <li>Buttons, sliders, checkboxes, etc.</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">ViewportToMesh</code>: <ul> <li>has a <code class="language-plaintext highlighter-rouge">SpatialMaterial</code> that takes a viewport texture (<code class="language-plaintext highlighter-rouge">Albedo</code> -&gt; <code class="language-plaintext highlighter-rouge">Texture</code> -&gt; <code class="language-plaintext highlighter-rouge">New ViewportTexture</code>)</li> <li>an export variable (<code class="language-plaintext highlighter-rouge">PackedScene</code>) to assign the <code class="language-plaintext highlighter-rouge">Viewport</code> node</li> <li>ensures UVs line up so that <code class="language-plaintext highlighter-rouge">(0,0)</code> in UV corresponds to <code class="language-plaintext highlighter-rouge">(0,0)</code> in the viewport, and <code class="language-plaintext highlighter-rouge">(1,1)</code> to <code class="language-plaintext highlighter-rouge">(width, height)</code></li> <li>sets an <code class="language-plaintext highlighter-rouge">Area</code> and <code class="language-plaintext highlighter-rouge">CollisionShape</code> on the mesh to match the viewport size (e.g. a plane of size <code class="language-plaintext highlighter-rouge">width x height</code>) for querying collisions</li> </ul> </li> </ul> <p>As a node-hierarchy this might look like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Spatial (World)
    ├── ViewportToMesh (MeshInstance)
    │    ├── Area
    │    │    └── CollisionShape
    │    └── Viewport (instanced PackedScene)
    ...
</code></pre></div></div> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/vr-toolkit/ViewportToMesh-480.webp 480w,/assets/img/vr-toolkit/ViewportToMesh-800.webp 800w,/assets/img/vr-toolkit/ViewportToMesh-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/vr-toolkit/ViewportToMesh.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <p>Conceptually, when a ray hits the mesh, we get:</p> <ol> <li>The hit position in local coordinates</li> <li>The UV coordinate of that point on the mesh</li> <li>The corresponding pixel in the viewport</li> </ol> <h2 id="ray-based-interaction--the-vr-laser-pointer">Ray-based Interaction – the VR laser pointer</h2> <p>The ray-based interaction lives in <code class="language-plaintext highlighter-rouge">GuiInteraction.gd</code>; a ray originates from the VR controller (or camera), which – every frame – it casts into the world. This gives a classic <strong>laser-pointer style UI</strong>:</p> <ul> <li>visual line from controller to panel.</li> <li>cursor on the panel (optionally drawn in the viewport).</li> <li>trigger button maps to “left mouse button”.</li> </ul> <p>The interesting bit is not the raycast itself (that’s standard Godot), but what happens in <code class="language-plaintext highlighter-rouge">_send_mouse_motion</code> and <code class="language-plaintext highlighter-rouge">_send_mouse_button</code> – that’s where we fake mouse events.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/vr-toolkit/RayInteract-480.webp 480w,/assets/img/vr-toolkit/RayInteract-800.webp 800w,/assets/img/vr-toolkit/RayInteract-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/vr-toolkit/RayInteract.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h2 id="finger-based-interaction--poking-buttons">Finger-based Interaction – poking buttons</h2> <p><code class="language-plaintext highlighter-rouge">GuiFinger.gd</code> is the second interaction mode: <strong>direct hand interaction</strong>.</p> <p>Instead of a laser pointer, we have:</p> <ul> <li>A VR hand skeleton or mesh.</li> <li>A collider on the fingertip (e.g. index finger).</li> <li>The finger collider collides with the GUI mesh.</li> </ul> <p>The flow is essentially:</p> <ol> <li>The finger collider overlaps with the GUI mesh or a dedicated interaction volume.</li> <li>From the collision, we again get: <ul> <li>Contact point on the mesh,</li> <li>UV coordinate at that point.</li> </ul> </li> <li>From UV we compute viewport coordinates.</li> <li>From those coordinates we synthesize: <ul> <li>Hover events while finger is near the surface,</li> <li>A “click” when the finger crosses some threshold (e.g. penetration depth / velocity / pinch gesture).</li> </ul> </li> </ol> <p>Where the ray pointer feels a bit like a laser pointer/remote, <strong>finger interaction feels like actually poking the UI</strong> – but internally, both boil down to the same <code class="language-plaintext highlighter-rouge">InputEventMouse</code>-machinery.</p> <h2 id="faking-mouse-events">Faking Mouse Events</h2> <p>Now the fun part: <strong>lying to Godot’s GUI</strong>.</p> <p>The goal: from the GUI’s perspective, nothing special is happening. It just sees mouse movement and clicks.</p> <h3 id="1-function-overview">1. Function overview</h3> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="nf">ray_interaction_input</span><span class="p">(</span><span class="n">position3D</span><span class="p">:</span> <span class="kt">Vector3</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">pressed</span><span class="o">=</span><span class="kt">null</span><span class="p">):</span>
</code></pre></div></div> <p>This function turns a <strong>3D hit position on the GUI mesh</strong> into a <strong>2D mouse-like input event</strong> for a viewport.</p> <ul> <li><code class="language-plaintext highlighter-rouge">position3D</code>: where the ray (or fingertip) hit the GUI in world space.</li> <li><code class="language-plaintext highlighter-rouge">event_type</code>: which kind of mouse event to create (<code class="language-plaintext highlighter-rouge">InputEventMouseMotion</code> or <code class="language-plaintext highlighter-rouge">InputEventMouseButton</code>).</li> <li><code class="language-plaintext highlighter-rouge">device_id</code>: which input device (controller) this event belongs to.</li> <li><code class="language-plaintext highlighter-rouge">pressed</code>: only relevant for button events, indicates down/up.</li> </ul> <p>The rest of the function:</p> <ol> <li>Converts coordinates into viewport space.</li> <li>Builds the appropriate mouse event.</li> <li>Sends it into the viewport so regular Godot <code class="language-plaintext highlighter-rouge">Control</code> nodes react to it.</li> </ol> <h3 id="2-world---local---2d-panel-coordinates">2. World -&gt; local -&gt; 2D panel coordinates</h3> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">position3D</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">global_transform</span><span class="o">.</span><span class="n">affine_inverse</span><span class="p">()</span> <span class="o">*</span> <span class="n">position3D</span>
	<span class="k">var</span> <span class="n">position2D</span> <span class="o">=</span> <span class="kt">Vector2</span><span class="p">(</span><span class="n">position3D</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position3D</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">area.global_transform.affine_inverse()</code> converts the world-space hit position into the <strong>local space of <code class="language-plaintext highlighter-rouge">area</code></strong> (the GUI panel / collision area).</li> <li>Because the panel is rotated by 90°, its surface is aligned in the <strong>X–Z plane</strong>.</li> <li>So we keep only <code class="language-plaintext highlighter-rouge">(x, z)</code> and throw away the third dimension, ending up with a <strong>2D point on the panel</strong>: <code class="language-plaintext highlighter-rouge">position2D</code>.</li> </ul> <p>At this point, <code class="language-plaintext highlighter-rouge">position2D</code> still uses the panel’s own local units, centered on its origin.</p> <h3 id="3-local-panel-coordinates---normalized-uv---viewport-pixels">3. Local panel coordinates -&gt; normalized UV -&gt; viewport pixels</h3> <h4 id="centered-local-range---0-based-quad-range">Centered local range -&gt; 0-based quad range</h4> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">position2D</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">quad_mesh_size</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="n">position2D</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">quad_mesh_size</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="mi">2</span>
</code></pre></div></div> <ul> <li>The quad is centered at <code class="language-plaintext highlighter-rouge">(0, 0)</code> with extents <code class="language-plaintext highlighter-rouge">±quad_mesh_size/2</code>.</li> <li>By adding half the size, we shift the coordinate system so it runs from <strong>0 to <code class="language-plaintext highlighter-rouge">quad_mesh_size</code></strong> in both directions.</li> <li>Now <code class="language-plaintext highlighter-rouge">(0, 0)</code> is one corner of the quad and <code class="language-plaintext highlighter-rouge">(quad_mesh_size.x, quad_mesh_size.y)</code> is the opposite corner.</li> </ul> <h4 id="quad-range---normalized-01">Quad range -&gt; normalized 0..1</h4> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">position2D</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">position2D</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">quad_mesh_size</span><span class="o">.</span><span class="n">x</span>
	<span class="n">position2D</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">position2D</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">quad_mesh_size</span><span class="o">.</span><span class="n">y</span>
</code></pre></div></div> <ul> <li>Dividing by the mesh size converts the coordinates into <strong>normalized UV space</strong>: <ul> <li><code class="language-plaintext highlighter-rouge">0.0</code> -&gt; start of the axis,</li> <li><code class="language-plaintext highlighter-rouge">1.0</code> -&gt; end of the axis.</li> </ul> </li> </ul> <p>So <code class="language-plaintext highlighter-rouge">position2D</code> is now in the range <code class="language-plaintext highlighter-rouge">(0..1, 0..1)</code> and basically matches the UVs of the quad.</p> <h4 id="normalized-uv---viewport-pixel-coordinates">Normalized UV -&gt; viewport pixel coordinates</h4> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">position2D</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">position2D</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">viewport</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span>
	<span class="n">position2D</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">position2D</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">viewport</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span>
</code></pre></div></div> <ul> <li>Multiplying the normalized values by the viewport size maps them to <strong>actual pixel positions</strong> inside the viewport.</li> <li>Now: <ul> <li><code class="language-plaintext highlighter-rouge">(0, 0)</code> is the top-left corner of the viewport.</li> <li><code class="language-plaintext highlighter-rouge">(viewport.size.x, viewport.size.y)</code> is the bottom-right.</li> </ul> </li> </ul> <p>This is exactly the coordinate system Godot’s GUI expects for mouse events.</p> <hr/> <h2 id="4-creating-and-configuring-the-mouse-event">4. Creating and configuring the mouse event</h2> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">var</span> <span class="n">event</span> <span class="o">=</span> <span class="n">event_type</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</code></pre></div></div> <p>Here we instantiate whichever mouse event type was passed in (<code class="language-plaintext highlighter-rouge">InputEventMouseMotion</code> or <code class="language-plaintext highlighter-rouge">InputEventMouseButton</code>).</p> <h3 id="mouse-motion">Mouse motion</h3> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">if</span> <span class="n">event</span> <span class="k">is</span> <span class="n">InputEventMouseMotion</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">last_pos2D</span> <span class="o">==</span> <span class="kt">null</span><span class="p">:</span>
			<span class="n">event</span><span class="o">.</span><span class="n">relative</span> <span class="o">=</span> <span class="kt">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">event</span><span class="o">.</span><span class="n">relative</span> <span class="o">=</span> <span class="n">position2D</span> <span class="o">-</span> <span class="n">last_pos2D</span>
</code></pre></div></div> <ul> <li>For <strong>motion events</strong>, besides the absolute position we also fill <code class="language-plaintext highlighter-rouge">relative</code>: <ul> <li>If this is the first event, there is no previous position -&gt; relative movement is <code class="language-plaintext highlighter-rouge">(0, 0)</code>.</li> <li>Otherwise we subtract <code class="language-plaintext highlighter-rouge">last_pos2D</code> from the new position for a <strong>movement delta</strong>.</li> </ul> </li> <li>This delta can be used internally by Godot or custom logic to know how far the pointer moved.</li> </ul> <h3 id="mouse-button">Mouse button</h3> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">elif</span> <span class="n">event</span> <span class="k">is</span> <span class="n">InputEventMouseButton</span><span class="p">:</span>
		<span class="n">event</span><span class="o">.</span><span class="n">button_index</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">event</span><span class="o">.</span><span class="n">pressed</span> <span class="o">=</span> <span class="n">pressed</span>
</code></pre></div></div> <ul> <li>For <strong>button events</strong>, we set: <ul> <li><code class="language-plaintext highlighter-rouge">button_index = 1</code> -&gt; left mouse button.</li> <li><code class="language-plaintext highlighter-rouge">pressed</code> -&gt; uses the argument passed into the function to differentiate between button-down and button-up.</li> </ul> </li> </ul> <hr/> <h2 id="5-final-bookkeeping-and-sending-the-event">5. Final bookkeeping and sending the event</h2> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">last_pos2D</span> <span class="o">=</span> <span class="n">position2D</span>
	<span class="n">event</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position2D</span>
	<span class="n">event</span><span class="o">.</span><span class="n">global_position</span> <span class="o">=</span> <span class="n">position2D</span>

	<span class="n">event</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device_id</span>
	<span class="n">viewport</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">last_pos2D</code> is updated so the next motion event can compute a correct <code class="language-plaintext highlighter-rouge">relative</code> delta.</li> <li><code class="language-plaintext highlighter-rouge">event.position</code> and <code class="language-plaintext highlighter-rouge">event.global_position</code> are both set to the computed viewport coordinates (for GUI, these are typically the same).</li> <li><code class="language-plaintext highlighter-rouge">event.device</code> identifies which controller generated this event.</li> <li>Finally, <code class="language-plaintext highlighter-rouge">viewport.input(event)</code> injects the event into the viewport’s input pipeline.</li> </ul> <p>From this point on, Godot treats it like a <strong>normal mouse event</strong>:</p> <ul> <li>Buttons, sliders, and other <code class="language-plaintext highlighter-rouge">Control</code> nodes react to hover and clicks.</li> <li>No special VR logic is needed in the UI layer – everything is handled via synthetic mouse events.</li> </ul> <p>The nice part is that <strong>dragging a slider</strong> via a VR ray is literally the same code path as dragging it with a real mouse.</p> <h2 id="edge-cases-trade-offs-and-thoughts">Edge Cases, Trade-offs and Thoughts</h2> <p>This approach works surprisingly well, but it’s not magic. A few gotchas and design decisions:</p> <h3 id="1-coordinate-precision--panel-curvature">1. Coordinate precision &amp; panel curvature</h3> <p>If you bend or distort your mesh (curved UI panels), you have to ensure:</p> <ul> <li>UVs are still meaningful,</li> <li>or you compute projection more explicitly (e.g. project onto plane, then transform).</li> </ul> <p><code class="language-plaintext highlighter-rouge">ViewportToMesh</code> acts as the contract: its job is to make sure <strong>“UV -&gt; viewport pixel”</strong> stays consistent.</p> <h3 id="2-focus-and-keyboard-input">2. Focus and keyboard input</h3> <p>Mouse is only half the story:</p> <ul> <li>Text input, keyboard focus, etc., still follow the usual Godot rules.</li> <li>Depending on your VR keyboard solution, you may want to: <ul> <li>Programmatically focus controls,</li> <li>Forward <code class="language-plaintext highlighter-rouge">InputEventKey</code> from a VR keyboard into the viewport.</li> </ul> </li> </ul> <p>The nice thing: you <strong>don’t</strong> have to change how <code class="language-plaintext highlighter-rouge">LineEdit</code> or <code class="language-plaintext highlighter-rouge">TextEdit</code> work, you just feed them events.</p> <h3 id="3-multiple-pointers--hands">3. Multiple pointers / hands</h3> <p>In VR you might have:</p> <ul> <li>Left-hand ray,</li> <li>Right-hand ray,</li> <li>Fingers on both hands.</li> </ul> <p>The mouse model assumes a single pointer. In practice, I make a conscious decision:</p> <ul> <li>Only one “active” pointer at a time.</li> <li>Usually taken from “last device that interacted” or a prioritized order (e.g. right-hand ray &gt; finger &gt; left-hand ray).</li> </ul> <p>For more complex setups you could emulate multiple mice by tagging events, but that quickly diverges from Godot’s standard assumptions.</p> <h3 id="4-when-not-to-fake-mouse-events">4. When <em>not</em> to fake mouse events</h3> <p>Not every VR interaction needs to pretend to be a mouse:</p> <ul> <li>Grabbing objects, teleportation, gunplay, etc. are better done via custom input handling.</li> <li>The “fake mouse” approach shines specifically when you want: <ul> <li>Menus,</li> <li>Settings panels,</li> <li>HUDs,</li> <li>Anything that logically <strong>is</strong> a 2D UI, just spatially placed.</li> </ul> </li> </ul> <h2 id="closing-thoughts">Closing Thoughts</h2> <blockquote> <p><strong>Start from the existing machinery, then adapt the edges.</strong></p> </blockquote> <p>By bending the inputs to look like mouse events, I can:</p> <ul> <li>Reuse all of that,</li> <li>Keep VR interaction code relatively small,</li> <li>Avoid building a bespoke VR widget library.</li> </ul> <p>The triad of <code class="language-plaintext highlighter-rouge">ViewportToMesh.gd</code>, <code class="language-plaintext highlighter-rouge">GuiInteraction.gd</code>, and <code class="language-plaintext highlighter-rouge">GuiFinger.gd</code> is essentially just:</p> <ul> <li>A 3D wrapper around a 2D viewport,</li> <li>Coordinate plumbing,</li> <li>And a thin layer of <strong>input forgery</strong>.</li> </ul> <p>From the user’s perspective it feels like <strong>“of course I can point at that button and press it”</strong>.<br/> From Godot’s perspective, they just moved a mouse and clicked.</p> <p>And that’s exactly the kind of cheating I enjoy.</p>]]></content><author><name>Mathias Baumgartinger</name></author><category term="software-engineering"/><category term="code"/><category term="godot"/><category term="vr"/><category term="gui"/><category term="input"/><category term="gamedev"/><summary type="html"><![CDATA[How I cheated my way to VR-friendly UI in Godot by raycasting into a mesh, projecting into a viewport -- and then faking mouse events.]]></summary></entry></feed>